<div class="flex group">
    <div class="block-handle mr-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
        <i class="fas fa-grip-vertical text-gray-400 cursor-grab hover:text-gray-600"></i>
    </div>
    <div class="flex-1">
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r shadow-sm">
            <div class="flex items-start">
                <div class="mr-3">
                    <span class="text-2xl select-none cursor-pointer hover:scale-110 transition-transform" 
                          onclick="{% if membership.can_edit %}changeCalloutIcon('{{ block.id }}'){% endif %}"
                          title="Click to change icon">{{ block.content.icon|default:"ðŸ’¡" }}</span>
                </div>
                <div contenteditable="{% if membership.can_edit %}true{% else %}false{% endif %}"
                     class="outline-none min-h-6 leading-relaxed flex-1 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-20 rounded-sm px-1 py-1 transition-all duration-200"
                     data-placeholder="Write a callout..."
                     onblur="updateBlockContent(this, '{{ block.id }}')"
                     oninput="handleBlockInput(this)">{{ block.content.text|default:"" }}</div>
            </div>
        </div>
    </div>
    {% if membership.can_edit %}
        <div class="block-actions opacity-0 group-hover:opacity-100 transition-opacity duration-200 ml-2 flex space-x-1">
            <button onclick="changeCalloutColor('{{ block.id }}')" 
                    class="text-gray-400 hover:text-blue-600 p-1 rounded hover:bg-blue-50 transition-colors"
                    title="Change callout color">
                <i class="fas fa-palette text-xs"></i>
            </button>
            <button onclick="changeCalloutIcon('{{ block.id }}')" 
                    class="text-gray-400 hover:text-yellow-600 p-1 rounded hover:bg-yellow-50 transition-colors" 
                    title="Change icon">
                <i class="fas fa-smile text-xs"></i>
            </button>
            <button onclick="duplicateBlock('{{ block.id }}')" 
                    class="text-gray-400 hover:text-gray-600 p-1 rounded hover:bg-gray-100 transition-colors"
                    title="Duplicate block">
                <i class="fas fa-copy text-xs"></i>
            </button>
            <button onclick="convertBlock('{{ block.id }}')" 
                    class="text-gray-400 hover:text-blue-600 p-1 rounded hover:bg-blue-50 transition-colors"
                    title="Convert block type">
                <i class="fas fa-exchange-alt text-xs"></i>
            </button>
            <button onclick="deleteBlock('{{ block.id }}')" 
                    class="text-gray-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition-colors"
                    title="Delete block">
                <i class="fas fa-trash text-xs"></i>
            </button>
        </div>
    {% endif %}
</div>

<script>
function changeCalloutIcon(blockId) {
    const newIcon = prompt('Enter new icon (emoji):', 'ðŸ’¡');
    if (newIcon) {
        const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
        const iconElement = blockElement.querySelector('span');
        iconElement.textContent = newIcon;
        
        // Update block content
        const textElement = blockElement.querySelector('[contenteditable]');
        updateBlockWithIcon(blockId, textElement.textContent, newIcon);
    }
}

function changeCalloutColor(blockId) {
    const colors = [
        { name: 'Blue', bg: 'bg-blue-50', border: 'border-blue-400' },
        { name: 'Yellow', bg: 'bg-yellow-50', border: 'border-yellow-400' },
        { name: 'Green', bg: 'bg-green-50', border: 'border-green-400' },
        { name: 'Red', bg: 'bg-red-50', border: 'border-red-400' },
        { name: 'Purple', bg: 'bg-purple-50', border: 'border-purple-400' },
        { name: 'Gray', bg: 'bg-gray-50', border: 'border-gray-400' }
    ];
    
    const colorChoice = prompt('Choose color:\n' + colors.map((c, i) => `${i + 1}. ${c.name}`).join('\n'));
    const colorIndex = parseInt(colorChoice) - 1;
    
    if (colorIndex >= 0 && colorIndex < colors.length) {
        const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
        const calloutDiv = blockElement.querySelector('.bg-blue-50, .bg-yellow-50, .bg-green-50, .bg-red-50, .bg-purple-50, .bg-gray-50');
        
        if (calloutDiv) {
            // Remove all color classes
            colors.forEach(color => {
                calloutDiv.classList.remove(color.bg, color.border.replace('border-', 'border-l-'));
            });
            
            // Add new color classes
            const selectedColor = colors[colorIndex];
            calloutDiv.classList.add(selectedColor.bg, selectedColor.border.replace('border-', 'border-l-'));
        }
    }
}

function updateBlockWithIcon(blockId, text, icon) {
    fetch(`/api/blocks/${blockId}/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}'
        },
        body: JSON.stringify({
            content: {
                text: text,
                icon: icon
            }
        })
    });
}
</script>