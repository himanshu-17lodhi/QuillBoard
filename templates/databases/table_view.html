{% extends 'base.html' %}
{% load quillboard_extras %}

{% block title %}{{ database.name }} - {{ workspace.name }}{% endblock %}

{% block main_class %}{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50">
    <!-- Sidebar -->
    <div class="w-64 bg-white border-r border-gray-200 flex flex-col sidebar-transition">
        <!-- Workspace Header -->
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center mr-3">
                    {% if workspace.icon %}
                        <span class="text-lg">{{ workspace.icon }}</span>
                    {% else %}
                        <i class="fas fa-layer-group text-indigo-600"></i>
                    {% endif %}
                </div>
                <div>
                    <h1 class="font-semibold text-gray-900 text-sm">{{ workspace.name }}</h1>
                    <p class="text-xs text-gray-500">{{ membership.get_role_display }}</p>
                </div>
            </div>
        </div>
        
        <!-- Database Navigation -->
        <div class="flex-1 overflow-y-auto p-4">
            <div class="mb-4">
                <a href="{% url 'workspaces:detail' workspace.slug %}" 
                   class="text-gray-600 hover:text-indigo-600 text-sm">
                    <i class="fas fa-arrow-left mr-2"></i>Back to {{ workspace.name }}
                </a>
            </div>
            
            <!-- Views -->
            <div class="mb-4">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Views</h3>
                <div class="space-y-1">
                    {% for db_view in all_views %}
                        <a href="{% url 'databases:view' workspace.slug database.id db_view.id %}"
                           class="flex items-center p-2 text-sm rounded-md {% if db_view.id == view.id %}bg-indigo-100 text-indigo-700{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                            {% if db_view.view_type == 'table' %}
                                <i class="fas fa-table mr-2"></i>
                            {% elif db_view.view_type == 'kanban' %}
                                <i class="fas fa-columns mr-2"></i>
                            {% elif db_view.view_type == 'gallery' %}
                                <i class="fas fa-th mr-2"></i>
                            {% elif db_view.view_type == 'list' %}
                                <i class="fas fa-list mr-2"></i>
                            {% elif db_view.view_type == 'calendar' %}
                                <i class="fas fa-calendar-alt mr-2"></i>
                            {% endif %}
                            {{ db_view.name }}
                        </a>
                    {% endfor %}
                    
                    {% if membership.can_edit %}
                        <button onclick="createView()" class="w-full text-left p-2 text-gray-600 hover:bg-gray-100 rounded-md text-sm">
                            <i class="fas fa-plus mr-2"></i>New View
                        </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Database Actions -->
            {% if membership.can_edit %}
                <div class="space-y-2">
                    <button onclick="addProperty()" class="w-full text-left p-2 text-gray-600 hover:bg-gray-100 rounded-md text-sm">
                        <i class="fas fa-plus mr-2"></i>Add Property
                    </button>
                    <button onclick="importData()" class="w-full text-left p-2 text-gray-600 hover:bg-gray-100 rounded-md text-sm">
                        <i class="fas fa-upload mr-2"></i>Import
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Database Header -->
        <div class="bg-white border-b border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        {% if database.icon %}
                            <span class="text-3xl mr-3">{{ database.icon }}</span>
                        {% else %}
                            <i class="fas fa-database text-3xl text-gray-400 mr-3"></i>
                        {% endif %}
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">{{ database.name }}</h1>
                            {% if database.description %}
                                <p class="text-gray-600">{{ database.description }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2">
                    <div class="text-sm text-gray-500">
                        {{ records|length }} record{{ records|length|pluralize }}
                    </div>
                    {% if membership.can_edit %}
                        <button onclick="addRecord()" 
                                class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 text-sm">
                            <i class="fas fa-plus mr-1"></i>New
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Table View -->
        <main class="flex-1 overflow-auto bg-white">
            <div class="min-w-full overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            {% for field in fields %}
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider relative group">
                                    <div class="flex items-center">
                                        <span>{{ field.name }}</span>
                                        <span class="ml-2 text-gray-400">
                                            {% if field.field_type == 'text' %}
                                                <i class="fas fa-font"></i>
                                            {% elif field.field_type == 'number' %}
                                                <i class="fas fa-hashtag"></i>
                                            {% elif field.field_type == 'select' %}
                                                <i class="fas fa-tags"></i>
                                            {% elif field.field_type == 'date' %}
                                                <i class="fas fa-calendar"></i>
                                            {% elif field.field_type == 'checkbox' %}
                                                <i class="fas fa-check-square"></i>
                                            {% else %}
                                                <i class="fas fa-question"></i>
                                            {% endif %}
                                        </span>
                                        {% if membership.can_edit %}
                                            <button class="ml-2 opacity-0 group-hover:opacity-100 text-gray-400 hover:text-gray-600"
                                                    onclick="editField('{{ field.id }}')">
                                                <i class="fas fa-cog text-xs"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </th>
                            {% endfor %}
                            {% if membership.can_edit %}
                                <th class="px-6 py-3 text-left">
                                    <button onclick="addProperty()" 
                                            class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for record in records %}
                            <tr class="hover:bg-gray-50 group">
                                {% for field in fields %}
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <div class="database-cell" 
                                             data-record-id="{{ record.id }}" 
                                             data-field-id="{{ field.id }}"
                                             data-field-type="{{ field.field_type }}">
                                            {% include 'databases/cells/'|add:field.field_type|add:'.html' with record=record field=field %}
                                        </div>
                                    </td>
                                {% endfor %}
                                {% if membership.can_edit %}
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <div class="opacity-0 group-hover:opacity-100 flex space-x-1">
                                            <button onclick="duplicateRecord('{{ record.id }}')" 
                                                    class="text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-copy text-xs"></i>
                                            </button>
                                            <button onclick="deleteRecord('{{ record.id }}')" 
                                                    class="text-gray-400 hover:text-red-600">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    </td>
                                {% endif %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="{{ fields|length|add:1 }}" class="px-6 py-12 text-center text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-database text-4xl text-gray-300 mb-4"></i>
                                        <p class="text-lg font-medium mb-2">No records yet</p>
                                        <p class="text-sm mb-4">Add your first record to get started.</p>
                                        {% if membership.can_edit %}
                                            <button onclick="addRecord()" 
                                                    class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                                                Add Record
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function addRecord() {
        // Create a new record with empty values
        fetch(`/api/databases/{{ database.id }}/records/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                data: {}
            })
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
    
    function addProperty() {
        const fieldName = prompt('Property name:');
        if (fieldName) {
            const fieldType = prompt('Property type (text, number, select, date, checkbox):', 'text');
            
            fetch(`/api/databases/{{ database.id }}/fields/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    name: fieldName,
                    field_type: fieldType,
                    order: {{ fields|length }}
                })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
    }
    
    function deleteRecord(recordId) {
        if (confirm('Are you sure you want to delete this record?')) {
            fetch(`/api/databases/{{ database.id }}/records/${recordId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
    }
    
    function duplicateRecord(recordId) {
        fetch(`/api/databases/{{ database.id }}/records/${recordId}/duplicate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
    
    function createView() {
        const viewName = prompt('View name:');
        if (viewName) {
            const viewType = prompt('View type (table, kanban, gallery, list, calendar):', 'table');
            
            fetch(`/api/databases/{{ database.id }}/views/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    name: viewName,
                    view_type: viewType
                })
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
            }).then(data => {
                if (data) {
                    window.location = `/databases/{{ workspace.slug }}/{{ database.id }}/view/${data.id}/`;
                }
            });
        }
    }
    
    // Handle cell editing
    document.addEventListener('dblclick', function(e) {
        const cell = e.target.closest('.database-cell');
        if (cell && {{ membership.can_edit|yesno:"true,false" }}) {
            const fieldType = cell.dataset.fieldType;
            const recordId = cell.dataset.recordId;
            const fieldId = cell.dataset.fieldId;
            
            editCell(cell, fieldType, recordId, fieldId);
        }
    });
    
    function editCell(cell, fieldType, recordId, fieldId) {
        const currentValue = cell.textContent.trim();
        
        if (fieldType === 'text') {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.className = 'w-full px-2 py-1 border border-gray-300 rounded';
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            
            function saveValue() {
                const newValue = input.value;
                updateRecordField(recordId, fieldId, newValue);
                cell.textContent = newValue;
            }
            
            input.addEventListener('blur', saveValue);
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    saveValue();
                }
            });
        }
    }
    
    function updateRecordField(recordId, fieldId, value) {
        const field = {{ fields|safe }}.find(f => f.id === fieldId);
        const fieldName = field ? field.name : 'unknown';
        
        const data = {};
        data[fieldName] = value;
        
        fetch(`/api/databases/{{ database.id }}/records/${recordId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: data })
        });
    }
</script>
{% endblock %}